---
title: "Statistical Analysis"
output: 
  html_document:
    toc: true
    toc_float: true 
    code_folding: hide 
editor_options: 
  chunk_output_type: console
---


This file contains ANOVA and respective post-hoc tests of the dataset.


Load & Clean Data

```{r message=FALSE, warning=FALSE, include=FALSE}

library(tidyverse)
library(janitor)
library(lubridate)
library(leaflet)
library(crosstalk)
library(htmltools)
library(DT)
library(modelr) 
library(mgcv) 

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
  )


```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE}
airplane_df = read_csv("datasets/airplane_crashes_data.csv", show_col_types = FALSE) |>
  clean_names() |>
  filter(ground != "NULL", aboard != "NULL") |>
  select(-flight_number, -time, -registration)
```

```{r, echo=FALSE}
airplane_df = airplane_df |> 
  mutate(
  
    date = str_trim(date),
    
      m = as.numeric(sub("/.*", "", date)),                    
    d = as.numeric(sub(".*/(.*)/.*", "\\1", date)),          
    y = as.numeric(sub(".*/(.*)$", "\\1", date)),            
    
    y = ifelse(y < 100, y + 1900, y),
    
    date_clean = paste(m, d, y, sep = "/"),
    
    date = mdy(date_clean),
    
    year = year(date),
    month = month(date),
    month_name = factor(month(date, 
                              label = TRUE, 
                              abbr = TRUE), 
                              levels = month.abb)
  ) |>
  select(-m, -d, -y, -date_clean) 
```

```{r, echo=FALSE}
airplane_df = airplane_df |>
  mutate(
    aboard     = as.numeric(aboard),
    fatalities = as.numeric(fatalities),
    ground     = as.numeric(ground),
    operator   = as.factor(operator)
  )
```

```{r echo = FALSE}
airplane_df = airplane_df |> 
  mutate(
    decade = floor(year / 10) * 10, 
    decade = paste0(decade, "s")
  ) |> 
  select(date, year, decade, month, month_name, everything()) 

geocoded_locations = read_csv("datasets/geocoded_cache.csv")

df_map <- airplane_df |>
  left_join(geocoded_locations, by = c("location" = "location_clean")) |>
  filter(!is.na(Latitude), !is.na(Longitude))
```
--- 

## Are total airplane crashes evenly distributed across the four seasons?

To investigate potential seasonal trends in aviation safety, we selected data from Northern Hemisphere and grouped the crash data by month of the accident. We then performed a Chi-Squared Test to determine if total historical crashes were evenly distributed throughout the year. The null hypothesis assumed that accidents occurred with equal frequency across all months. 

The analysis revealed a statistically significant difference in crash frequency across seasons. The Chi-Squared test yielded a p-value below the 0.05 significance threshold, allowing us to reject the null.

```{r chisq for crash distribution across season}

airplane_north = df_map |>
  filter(aboard > 0, !is.na(fatalities))|>
   filter(Latitude> 0)|> 
  mutate(
    survival_rate = (aboard - fatalities) / aboard,
    month_num     = month(date),
    season = case_when(
      month_num %in% c(12, 1, 2)  ~ "Winter",
      month_num %in% c(3, 4, 5)   ~ "Spring",
      month_num %in% c(6, 7, 8)   ~ "Summer",
      month_num %in% c(9, 10, 11) ~ "Fall"
    )
  ) |>
  filter(!is.na(season)) |>
  mutate(season = fct_relevel(season, "Spring", "Summer", "Fall", "Winter"))

  
month_summary = airplane_north |>
   filter(Latitude> 0)|> 
  count(month, name = "n")|>
  # ---- compute expected + chisq ----
    mutate(
    expected = mean (n),
    chisq = list(chisq.test(n)),
    residual = n - expected,
    std_resid = (n - expected) / sqrt(expected)
  )|> print()
  
# extract p-value
chisq_p = month_summary$chisq[[1]]$p.value
chisq_p


# ---- plot ----
month_summary |>
  ggplot(aes(month, n)) +
  geom_col(fill = "steelblue") +
  geom_hline(aes(yintercept = expected),
             linetype = "dashed", size = 1) +
  scale_x_continuous(breaks = 1:12) +
  labs(
    title = "Total Crashes by month",
    subtitle = paste("Chi-Square p-value =", format.pval(chisq_p)),
    x = "Month",
    y = "Total Number of Crashes"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

## Does the average yearly crashes differ across the months?

The Chi-Squared test examined aggregate totals, but it did not account for year-to-year variability. To address this, we aggregated crash counts by year and season to calculate the mean yearly crash rate. We then performed a One-Way ANOVA to determine if the average number of airplane crashes per year differs significantly across the months.

The ANOVA results yielded a p-value of 0.039, which was below the 0.05 significance level. 

```{r anova for seaonal crashes per year}

cat("=== ANOVA result ===\n")
airplane_north |> 
  # Count crashes per year/season combo
  count(year, month, name = "crash_count")|>

# ANOVA 
aov(crash_count ~ factor(month), data = _) |> 
  summary()

# ---- plot ----
 airplane_north |> 
  count(year, month, name = "crash_count")|>
  group_by(month) |>
  summarise(
    mean_crashes = mean(crash_count),
    se = sd(crash_count) / sqrt(n())
  ) |>
  ggplot(aes(x = month, y = mean_crashes)) +
  scale_x_continuous(breaks = 1:12) +
  geom_col(fill = "steelblue",show.legend = FALSE) +
  geom_errorbar(aes(ymin = mean_crashes - se,
                    ymax = mean_crashes + se),
                width = 0.15) +
  labs(
    title = "Average Yearly Airplane Crashes in Northern Hemisphere by Month",
        x = "Month",
    y = "Average Crash Count"
  ) +
  theme_minimal()

```

## What about differences of fatality rate across months?

No significant evidence suggested a monthly difference of fatality rate.

```{r anova for season and fatality}

cat("=== ANOVA result ===\n")

airplane_north|>
 ##ANOVA
aov(survival_rate ~ factor(month), data = _ )|>
summary()


```
## Is the fatality rate lower over the years?

Statistical evidence confirmed that airplanes have become safer over time regarding rate of survival. Linear regression analysis revealed a statistically significant negative correlation between year and fatality rate (p < 0.001). 

However, the low R-squared value (0.004) indicated that while the downward trend is consistent, the outcome of any individual crash is heavily influenced by situational factors other than just the time period.

```{r lm year ~ fatality}

 airplane_df |> 
  filter(aboard > 0, !is.na(fatalities)) |> 
  mutate(fatality_rate = fatalities / aboard) |> 
  group_by(year) |> 
  summarise(mean_fatality_rate = mean(fatality_rate)) |> 
  ggplot(aes(x = year, y = mean_fatality_rate)) +
  geom_point(color = "steelblue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", fill = "pink",se = TRUE) +
  labs(
    title = "Trend in Airplane Fatality Rate Over Time",,
    x = "Year",
    y = "Average Fatality Rate"
  ) +
  theme_minimal()

 airplane_df|>
  filter(aboard > 0, !is.na(fatalities)) |> 
  
  ## Calculate fatality rate
  mutate(fatality_rate = fatalities / aboard) |> 
  ## for individual event
 lm(fatality_rate ~ year, data = _)|> summary()


```


## Are the number of crash events higher or lower over the years?

To describe the historical trend of aviation safety, we aggregated the total number of crashes per year. We then fitted a simple linear regression model to determine if there was a statistically significant linear increase or decrease in crash frequency over the recorded time period (1908â€“2009).

The linear regression analysis revealed a statistically significant upward trend.

```{r}

crashes_by_year = airplane_df |> 
  count(year, name = "total_crashes")

ggplot(crashes_by_year, aes(x = year, y = total_crashes)) +
  geom_point(color = "steelblue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", fill = "pink") +
  labs(
    title = "Trend of Total Airplane Crashes per Year",
    x = "Year",
    y = "Total Number of Crashes"
  ) +
  theme_minimal()

fit_count <- lm(total_crashes ~ year, data = crashes_by_year)

summary(fit_count)
```

## Cross validation : linear vs pwl vs smooth

While the SLR suggested a significant upward trend, visual inspection implied a non-linear pattern with distinct peaks and valleys. To scientifically determine the best approach for describing this historical data, we performed Cross-Validation (CV). We compared three candidate models: a linear model, a piece wise linear model (assuming a structural break around 1990), and a generalized additive model (GAM) using smoothing splines. We evaluated them based on their ability to predict unseen data subsets.

```{r cross validation}

crashes_by_year     = airplane_df |> 
  count(year, name  = "total_crashes")|>
  mutate(year_cp1990= (year > 1990) * (year - 1990))

set.seed(1)
cv_df = crossv_mc(crashes_by_year, 100)

linear_mod = lm(total_crashes ~ year, data = crashes_by_year)
pwl_mod    = lm(total_crashes ~ year + year_cp1990, data = crashes_by_year)
smooth_mod = gam(total_crashes ~ s(year), data = crashes_by_year)
## compare 3 models
## visually smooth mod is better
crashes_by_year |> 
  gather_predictions(linear_mod, pwl_mod, smooth_mod) |> 
  mutate(model = fct_inorder(model)) |> 
  ggplot(aes(x = year, y = total_crashes)) + 
  geom_point(alpha = .5) +
  geom_line(aes(y = pred), color = "red") + 
  facet_grid(~model)
             
cv_df <- cv_df |> 
  mutate(
    train = map(train, as_tibble),
    test  = map(test, as_tibble)
  ) |> 
  mutate(
    
    linear_mod = map(train, \(df) lm(total_crashes ~ year, data = df)),
    pwl_mod     = map(train, \(df) lm(total_crashes ~ year + year_cp1990, data = df)),
    smooth_mod = map(train, \(df) gam(total_crashes ~ s(year), data = df))
  ) |> 
  mutate(
    # calculate RMSE
    rmse_linear = map2_dbl(linear_mod, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_pwl   = map2_dbl(pwl_mod, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_smooth = map2_dbl(smooth_mod, test, \(mod, df) rmse(model = mod, data = df))
  )


cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_"
  ) |> 
  mutate(model = fct_inorder(model)) |> 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin()

summary(smooth_mod)
```

The visual comparison of the cross-validated predictions clearly demonstrated the limitations of the linear model. The linear fit (left panel) failed to capture the mid-century rise and the late-century decline in crashes, resulting in high systematic error. The piece wise model (middle panel) offered an improvement by accounting for the recent downtrend, but the Smooth (GAM) model (right panel) provides the superior fit. 