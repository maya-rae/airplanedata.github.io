---
title: "Interactive Map"
output: github_document
---

```{r, include=FALSE, echo=FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
library(leaflet)
library(crosstalk)
library(htmltools)
library(DT)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r, echo=FALSE}
airplane_df = read_csv("datasets/airplane_crashes_data.csv") |>
  clean_names() |>
  filter(ground != "NULL", aboard != "NULL") |>
  select(-flight_number, -time, -registration)
```

```{r, echo=FALSE}
airplane_df = airplane_df |>
  mutate(
    date = str_trim(date),
    m = as.numeric(sub("/.*", "", date)),
    d = as.numeric(sub(".*/(.*)/.*", "\\1", date)),
    y = as.numeric(sub(".*/(.*)$", "\\1", date)),
    y = ifelse(y < 100, y + 1900, y),
    date_clean = paste(m, d, y, sep = "/"),
    date = mdy(date_clean),
    year = year(date)
  ) |>
  select(-m, -d, -y, -date_clean)
```

```{r, echo=FALSE}
airplane_df = airplane_df |>
  mutate(
    aboard     = as.numeric(aboard),
    fatalities = as.numeric(fatalities),
    ground     = as.numeric(ground),
    operator   = as.factor(operator)
  )
```

```{r, echo=FALSE}
geocoded_locations = read_csv("datasets/geocoded_cache.csv")

df_map <- airplane_df |>
  left_join(geocoded_locations, by = c("location" = "location_clean")) |>
  filter(!is.na(Latitude), !is.na(Longitude))
```

---

## Interactive Filters + Map and Table

This interactive dashboard displays airplane crash locations using a linked map and data table. A filter panel allows users to dynamically select crashes by year, operator, and number of fatalities. Selecting a filter instantly updates both the map and the table through Crosstalk. Each marker represents a crash event and includes detailed information in a popup.

```{r, echo=FALSE}
# crosstalk dataset
df_display = df_map |>
  mutate(
    year = as.factor(year),
    operator = as.factor(operator)
  ) |>
  select(year, operator, date, location, fatalities, Latitude, Longitude)

shared = SharedData$new(df_display, group = "crashes")

# Filter Sidebar + Map + Table
bscols(
  widths = c(3, 9),

  # ==== FILTER SIDEBAR ====
  list(
    tags$h3("Filter Crashes"),
    filter_select("year_filter", "Year:", shared, ~year),
    filter_select("op_filter", "Operator:", shared, ~operator),
    filter_slider("fat_filter", "Fatalities:", shared, ~fatalities)
  ),

  # ==== MAP + TABLE AREA ====
  bscols(
    widths = c(7, 5),

    # MAP
    leaflet(shared) |>
      addProviderTiles(providers$CartoDB.Positron) |>
      addCircleMarkers(
        lng = ~Longitude,
        lat = ~Latitude,
        radius = 5,
        fillColor = "red",
        color = "red",
        fillOpacity = 0.6,
        popup = ~paste0(
          "<b>Date:</b> ", date, "<br>",
          "<b>Operator:</b> ", operator, "<br>",
          "<b>Location:</b> ", location, "<br>",
          "<b>Fatalities:</b> ", fatalities
        )
      ) |>
      setView(lng = 0, lat = 20, zoom = 2),

    # TABLE
    DT::datatable(
      shared,
      filter = "top",
      rownames = FALSE,
      options = list(
        pageLength = 2,
        lengthChange = FALSE,
        searching = TRUE,
        autoWidth = TRUE,
        columnDefs = list(
          list(visible = FALSE, targets = c(5, 6))  # hide lat/long
        )
      )
    )
  )
)
```

## Heatmap -- Crash Intensity Heat Layer 

This map displays all airplane crash locations in the dataset using marker clustering. Each marker represents an individual crash, showing the crash date and airline operator in a popup. Clustering helps visualize dense regions by grouping nearby crashes together, expanding into individual points as the user zooms in.

```{r}
leaflet(df_map) |>
  addProviderTiles(providers$CartoDB.Positron) |>
  addMarkers(
    lng = ~Longitude,
    lat = ~Latitude,
    clusterOptions = markerClusterOptions(),
    popup = ~paste("Date:", date, "<br>", "Operator:", operator)
  )

```

```{r}
airplane_df = airplane_df |>
  mutate(
    date = mdy(str_trim(date)),   # fixed
    year = year(date),
    month = month(date),
    operator = as.factor(operator),
    fatalities = as.numeric(fatalities),
    ground = as.numeric(ground),
    aboard = as.numeric(aboard)
  )

```


## Color-coded operator map

This map visualizes the top five airline operators with the highest number of airplane crashes in the dataset. Each point represents a crash site, positioned according to its recorded latitude and longitude. Operators are color-coded, allowing easy comparison of where different airlines have experienced accidents worldwide. Pop-ups display the airline name, crash date, and location for additional context. The legend identifies the five airlines included in the visualization.

```{r}
# Top 5 operators by number of crashes
top_ops = df_map |>
  count(operator, sort = TRUE) |>
  slice(1:5) |>
  pull(operator)

# Filter dataset for ONLY these operators
df_top = df_map |> 
  filter(operator %in% top_ops)

#  palette for the 5 operators
pal = colorFactor(
  palette = rainbow(length(top_ops)),
  domain = top_ops
)

# Leaflet map
leaflet(df_top) |>
  addProviderTiles(providers$CartoDB.Positron) |>
  addCircleMarkers(
    lng = ~Longitude,
    lat = ~Latitude,
    color = ~pal(operator),
    fillOpacity = 0.8,
    radius = 6,
    popup = ~paste0(
      "<b>Operator:</b> ", operator, "<br>",
      "<b>Date:</b> ", format(date, "%Y-%m-%d"), "<br>",
      "<b>Location:</b> ", location
    )
  ) |>
  addLegend(
    position = "bottomright",
    pal = pal,
    values = df_top$operator,
    title = "Top 5 Operators"
  )

```

