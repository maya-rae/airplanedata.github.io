---
title: "Airplane Crash Map"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r}
library(tidyverse)
library(janitor)
library(lubridate)
library(leaflet)
library(flexdashboard)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

```{r}
airplane_df <- read_csv("datasets/airplane_crashes_data.csv") %>%
clean_names() %>%
filter(ground != "NULL", aboard != "NULL") %>%
select(-flight_number, -time, -registration) %>%
mutate(
date = str_trim(date),
m = as.numeric(sub("/.*", "", date)),
d = as.numeric(sub(".*/(.*)/.*", "\1", date)),
y = as.numeric(sub(".*/(.*)$", "\1", date)),
y = ifelse(y < 100, y + 1900, y),
date_clean = paste(m, d, y, sep = "/"),
date = mdy(date_clean),
year = year(date),
aboard = as.numeric(aboard),
fatalities = as.numeric(fatalities),
ground = as.numeric(ground),
operator = as.factor(operator),
location_clean = location %>%
str_to_lower() %>% str_replace_all("[^a-z0-9 ]", " ") %>% str_squish()
) %>%
select(-m, -d, -y, -date_clean)

geocoded <- read_csv("datasets/geocoded_cache.csv") %>%
mutate(
location_clean2 = location_clean %>%
str_to_lower() %>% str_replace_all("[^a-z0-9 ]", " ") %>% str_squish()
)

df_map <- airplane_df %>%
left_join(geocoded, by = c("location_clean" = "location_clean2")) %>%
filter(!is.na(Latitude), !is.na(Longitude))

year_min <- min(df_map$year, na.rm = TRUE)
year_max <- max(df_map$year, na.rm = TRUE)

```


```{r}
sliderInput(
"year_choice",
"Select Year:",
min = year_min,
max = year_max,
value = year_min,
step = 1
)

```

```{r}
leafletOutput("map", height = "700px")

```

```{r}
renderLeaflet({
leaflet() %>%
addProviderTiles(providers$CartoDB.Positron)
})

```

```{r}
observe({
leafletProxy("map", data = df_map %>% filter(year == input$year_choice)) %>%
clearMarkers() %>%
addCircleMarkers(
lng = ~Longitude,
lat = ~Latitude,
radius = 4,
color = "red",
fillOpacity = 0.3,
popup = ~paste(
"<b>Operator:</b>", operator, "<br>",
"<b>Location:</b>", location, "<br>",
"<b>Date:</b>", date
)
)
})

```

